{% extends "base.html" %}

{% block title %}{{ task.title }} - Task Details{% endblock %}

{% block content %}
<section class="task-detail-section">
    <div class="container">
        <div class="back-link">
            <a href="{{ url_for('index') }}">‚Üê Back to Tasks</a>
        </div>

        <div class="task-detail-grid">
            <div class="task-info">
                <div class="task-header">
                    <h1>{{ task.title }}</h1>
                    <span class="task-status status-{{ task.status }}">{{ task.status.title() }}</span>
                </div>

                <div class="task-description">
                    <h3>Task Description</h3>
                    <p>{{ task.description }}</p>
                </div>

                {% if task.reference_image %}
                    <div class="reference-image">
                        <h3>Reference Image</h3>
                        <img src="{{ url_for('static', filename='uploads/tasks/' + task.reference_image) }}" 
                             alt="{{ task.title }}"
                             class="clickable-reference-image"
                             onclick="openImageModal('{{ url_for('static', filename='uploads/tasks/' + task.reference_image) }}', '{{ task.title }}')"
                             title="Click to view full size">
                        <p class="image-hint">üîç Click image to view full size</p>
                    </div>
                {% endif %}

                <div class="task-meta-info">
                    <div class="meta-item">
                        <strong>Task ID:</strong> {{ task.id }}
                    </div>
                    <div class="meta-item">
                        <strong>Created:</strong> {{ task.created_at[:10] if task.created_at else 'Recently' }}
                    </div>
                </div>
            </div>

            <div class="submission-form">
                <div class="form-card">
                    <h3>Submit Your Proof</h3>
                    <p>Upload 1-3 screenshots or photos showing you've completed this task</p>

                    <form method="POST" action="{{ url_for('submit_task', task_id=task.id) }}" enctype="multipart/form-data" id="submissionForm">
                        <div class="form-group">
                            <label for="user_name">Your Name</label>
                            <input type="text" id="user_name" name="user_name" required>
                        </div>

                        <div class="form-group">
                            <label for="user_email">Your Email</label>
                            <input type="email" id="user_email" name="user_email" required>
                        </div>

                        <!-- NEW MOBILE NUMBER FIELD -->
                        <div class="form-group">
                            <label for="mobile_number">Your Mobile Number</label>
                            <input type="tel"
                                   id="mobile_number"
                                   name="mobile_number"
                                   pattern="[0-9]{10,15}"
                                   placeholder="Enter 10-15 digit mobile number"
                                   required>
                            <small class="form-text">Enter your mobile number (10-15 digits)</small>
                        </div>

                        <!-- NEW BANK DETAILS SECTION -->
                        <div class="form-group">
                            <label for="account_holder_name">Account Holder Name</label>
                            <input type="text"
                                   id="account_holder_name"
                                   name="account_holder_name"
                                   placeholder="Enter account holder name"
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="bank_account_number">Bank Account Number</label>
                            <input type="text"
                                   id="bank_account_number"
                                   name="bank_account_number"
                                   pattern="[0-9]{8,20}"
                                   placeholder="Enter bank account number"
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="bank_name">Bank Name</label>
                            <input type="text"
                                   id="bank_name"
                                   name="bank_name"
                                   placeholder="Enter bank name"
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="ifsc_code">IFSC Code</label>
                            <input type="text"
                                   id="ifsc_code"
                                   name="ifsc_code"
                                   pattern="[A-Za-z]{4}[0-9A-Za-z]{7}"
                                   placeholder="Enter IFSC code (e.g. HDFC0001234)"
                                   required>
                        </div>

                        <div class="form-group">
                            <label for="branch_name">Branch Name</label>
                            <input type="text"
                                   id="branch_name"
                                   name="branch_name"
                                   placeholder="Enter branch name (optional)">
                        </div>

                        <div class="form-group">
                            <label for="confirmation_mobile">Mobile Number for Confirmation</label>
                            <input type="tel"
                                   id="confirmation_mobile"
                                   name="confirmation_mobile"
                                   pattern="[0-9]{10,15}"
                                   placeholder="Enter mobile number for payment confirmation"
                                   required>
                            <small class="form-text">We will use this number for payout confirmations.</small>
                        </div>
                        <!-- END BANK DETAILS SECTION -->

                        <div class="form-group">
                            <label for="proof_image">Proof Images (1-3 required)</label>
                            <div class="file-upload-area" id="fileUploadArea">
                                <input type="file"
                                       id="proof_image"
                                       name="proof_image"
                                       multiple
                                       accept="image/*"
                                       required>
                                <div class="file-upload-text">
                                    <span class="upload-icon">üì∏</span>
                                    <span>Click to upload or drag and drop</span>
                                    <small>Select 1-3 images ‚Ä¢ PNG, JPG, GIF up to 5MB each</small>
                                </div>
                            </div>
                            <div id="fileMessage" class="file-message"></div>
                            <div id="filePreview" class="file-preview"></div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" id="submitBtn">Submit Proof</button>
                    </form>
                </div>

                <div class="submission-tips">
                    <h4>üìù Submission Tips</h4>
                    <ul>
                        <li><strong>Upload 1-3 images:</strong> Multiple angles or steps of your completion</li>
                        <li><strong>High quality:</strong> Clear, well-lit photos for faster approval</li>
                        <li><strong>Show progress:</strong> Include before, during, and after shots if applicable</li>
                        <li><strong>Complete evidence:</strong> All required elements from task description</li>
                        <li><strong>Quick review:</strong> Submissions reviewed within 24-48 hours</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Full-Screen Image Modal -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <div class="image-modal-overlay">
        <!-- Top Right Controls -->
        <div class="modal-top-controls" onclick="event.stopPropagation()">
            <button type="button" class="modal-btn close-btn" onclick="closeImageModal()" title="Close">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span>Close</span>
            </button>
        </div>
        
        <!-- Image Container -->
        <div class="modal-image-container" onclick="event.stopPropagation()">
            <img id="modalImage" src="" alt="Full Screen Image">
        </div>
        
        <!-- Bottom Info Bar -->
        <div class="modal-info-bar" onclick="event.stopPropagation()">
            <span id="modalTitle">Reference Image</span>
            <span class="modal-hint">Press ESC to close</span>
        </div>
    </div>
</div>

<style>
/* Clickable Reference Image */
.clickable-reference-image {
    cursor: zoom-in;
    transition: all 0.3s ease;
    border-radius: 8px;
}

.clickable-reference-image:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.image-hint {
    text-align: center;
    color: #666;
    font-size: 0.85rem;
    margin-top: 8px;
}

/* Full-Screen Modal Styles */
.image-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: rgba(0, 0, 0, 0.92);
    backdrop-filter: blur(8px);
}

.image-modal-overlay {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Top Right Controls */
.modal-top-controls {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 12px;
    z-index: 2001;
}

.modal-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.modal-btn svg {
    flex-shrink: 0;
}

.modal-btn.download-btn {
    background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
    color: white;
}

.modal-btn.download-btn:hover {
    background: linear-gradient(135deg, #1e3a21 0%, #3d6b4a 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(44, 85, 48, 0.4);
}

.modal-btn.close-btn {
    background: rgba(255, 255, 255, 0.15);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.modal-btn.close-btn:hover {
    background: #dc3545;
    border-color: #dc3545;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 53, 69, 0.4);
}

/* Image Container */
.modal-image-container {
    max-width: 90%;
    max-height: 85%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#modalImage {
    max-width: 100%;
    max-height: 85vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    animation: imageZoomIn 0.3s ease;
}

@keyframes imageZoomIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Bottom Info Bar */
.modal-info-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    padding: 12px 24px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 30px;
    color: white;
    font-size: 14px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-info-bar #modalTitle {
    font-weight: 600;
}

.modal-info-bar .modal-hint {
    opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
    .modal-top-controls {
        top: 10px;
        right: 10px;
        gap: 8px;
    }
    
    .modal-btn {
        padding: 8px 12px;
        font-size: 12px;
    }
    
    .modal-btn span {
        display: none;
    }
    
    .modal-info-bar {
        padding: 10px 16px;
        font-size: 12px;
        gap: 10px;
    }
    
    .modal-info-bar .modal-hint {
        display: none;
    }
}
</style>

<script>
var currentImageSrc = '';

function openImageModal(src, title) {
    currentImageSrc = src;
    var modal = document.getElementById('imageModal');
    var image = document.getElementById('modalImage');
    var titleEl = document.getElementById('modalTitle');
    
    titleEl.textContent = title || 'Reference Image';
    modal.style.display = 'block';
    image.src = src;
    
    // Prevent body scrolling
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    var modal = document.getElementById('imageModal');
    var image = document.getElementById('modalImage');
    
    modal.style.display = 'none';
    image.src = '';
    currentImageSrc = '';
    
    // Restore body scrolling
    document.body.style.overflow = 'auto';
}

function downloadImage() {
    if (currentImageSrc) {
        var link = document.createElement('a');
        link.href = currentImageSrc;
        link.download = 'reference_image_' + new Date().getTime() + '.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    var modal = document.getElementById('imageModal');
    if (modal && modal.style.display === 'block') {
        if (e.key === 'Escape') closeImageModal();
    }
});
</script>
{% endblock %}
